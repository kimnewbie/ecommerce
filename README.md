# 프로젝트 동시성 이슈 및 제어 방식 분석 

```나의 시나리오에서 발생할 수 있는 동시성 이슈에 대해 파악하고 가능한 동시성 제어 방식들을 도입해보고 각각의 장단점을 파악한 내용을 정리 제출```

## 1. 선착순 쿠폰

### 동시성 이슈
선착순 쿠폰은 **한정된 수량**만큼만 제공되므로, 여러 사용자가 동시에 쿠폰을 요청할 경우 쿠폰 수량을 잘못 차감하는 현상이 발생할 수 있기 때문에, 이를 방지하기 위한 동시성 제어가 필수적으로 필요하다.

### 추천 락 방식

- **분산락 (Distributed Lock)**
    - **특징**: 여러 서버나 인스턴스에서 동시에 접근하는 경우, 분산 락을 사용하여 서버 간 동기화된 상태에서 쿠폰을 선착순으로 할당할 수 있다.
    - **장점**: 서버 간 동기화를 잘 유지할 수 있다.
    - **단점**: 분산 시스템에서는 락의 성능 저하가 있을 수 있으며, 락 해제 지연이나 락 경쟁으로 성능이 감소할 수 있다.

- **비관적 락 (Pessimistic Lock)**
    - **특징**: 선착순으로 쿠폰을 지급하므로, 쿠폰 수량을 체크하고 업데이트 할 때 비관적 락을 걸어 여러 사용자가 동시에 쿠폰을 할당받지 않도록 할 수 있다.
    - **장점**: DB에서 실제로 락을 걸어 데이터 수정 전까지 다른 트랜잭션이 접근하지 못하게 하므로 동시성 문제를 방지하여 고유한 쿠폰을 하나의 사용자만 가질 수 있도록 보장한다.
    - **단점**: 락이 걸린 동안 다른 트랜잭션이 대기하게 되므로 성능 저하가 발생할 수 있기 때문에 과도한 락 사용 시 성능 저하 및 데드락 발생 가능성도 존재하게 된다.

### 유진's PICK!
- 내가 생각하기에 **분산락**이 선착순 쿠폰 발행에 비관적 락보다 더 적합할 거 같다. 쿠폰 수량이 한정된 경우에는 분산락을 사용하는 것이 좋을 거 같다.

---

## 2. 상품의 재고 차감 및 복원

### 동시성 이슈
상품의 재고는 주문 처리 시 재고를 감소하는 과정에서 동시 요청이 들어오면 재고를 과잉 차감하는 문제가 발생하는 일이 생길 수 있다. 이를 방지하기 위한 동시성 제어가 필요하다.

### 추천 락 방식

- **비관적 락 (Pessimistic Lock)**
    - **특징**: 상품의 재고를 차감할 때, 재고 데이터를 락으로 보호하여 다른 주문이 동시에 진행되지 않도록 할 수 있다. 일르 통해 한 번에 하나의 주문만 재고를 차감할 수 있도록 보장할 수 있게 된다.
    - **장점**: 재고 수정 전에 데이터를 락으로 보호하여 다른 트랜잭션이 접근하지 못하도록 설정하여 데이터 일관성을 보장할 수 있다.
    - **단점**: 락이 걸리면 다른 주문들이 대기하게 되어 성능에 영향을 미치며, 높은 트래픽 상황에서는 대기 시간이 길어질 수 있다.

- **낙관적 락 (Optimistic Lock)**
    - **특징**: 데이터 충돌이 적을 것이라고 가정하고, 재고 차감 후에 업데이트가 발생하는 상황이 생기면 이 때 충돌을 감지하여 롤백하거나 재고 차감을 다시 시도하게 된다.
    - **장점**: 락을 거는 대신 데이터 수정 후에 충돌이 발생하지 않았는지 확인하는 방식으로 성능에 더 유리하다.
    - **단점**: 트랜잭션 충돌이 발생했을 경우 롤백과 재시도를 해야 하므로, 충돌 빈도가 높은 경우 성능이 저하될 수 있다.

### 유진's PICK!
- 재고 수량을 확인하고 수정하는 과정에서 충돌이 자주 발생할 수 있기 때문에 **낙관적 락**을 사용하여 성능 저하를 방지하면서, 충돌이 발생하면 재시도하는 방식으로 구현하는 것이 좋다고 생각한다. 또한 재고가 많고 급격한 변화가 없는 상황에서는 **비관적 락**도 고려할 수 있습니다.

---

## 3. 유저의 포인트 잔액

### 동시성 이슈
유저가 포인트를 적립하거나 사용할 때 여러 요청이 동시에 발생하면, 포인트 잔액이 잘못 업데이트 될 수 있다. 예를 들어, 두 요청이 동시에 들어와 포인트를 중복 차감하거나 과다 적립하는 상황 등에서 동시성 문제가 발생할 수 있다.

### 추천 락 방식

- **낙관적 락 (Optimistic Lock)**
    - **특징**: 포인트 잔액을 차감하고, 변경이 완료될 때까지 다른 트랜잭션에서 포인트를 변경하지 않도록 검사를 한다. 충돌이 발생하면 재시도를 하게 된다.
    - **장점**: 포인트 잔액은 상대적으로 충돌이 적으므로 성능을 우선시할 수 있으며, 사용자가 충돌을 일으키면 재시도하여 처리할 수 있다. 충돌이 적을 경우 성능이 우수하다.
    - **단점**: 충돌이 발생한 경우 롤백이 필요하며, 충돌 빈도가 높으면 성능에 악영향을 미칠 수 있다.

- **비관적 락 (Pessimistic Lock)**
    - **특징**: 포인트 잔액을 차감할 때 락을 걸어 다른 트랜잭션에서 동시에 포인트를 변경할 수 없도록 한다.
    - **장점**: 트랜잭션이 시작되면 바로 락을 걸어 다른 트랜잭션이 접근할 수 없도록 하여 데이터 무결성을 보장할 수 있다.
    - **단점**: 성능 저하가 발생할 수 있으며, 락 경쟁이 발생할 경우 시스템 성능에 큰 영향을 줄 수 있게 된다.

### 유진's PICK!
- 포인트 잔액의 변경은 비교적 충돌이 낮은 작업이므로 **낙관적 락**을 사용하는 것이 좋을 것 같다.

---

## 결론

### 각 도메인에 대한 추천 락 방식

1. **선착순 쿠폰**: **분산락** 또는 **비관적 락**을 사용하여 동시성 문제를 해결.
2. **상품의 재고 차감 및 복원**: **낙관적 락**을 우선 사용하고, 트래픽이 높은 경우 **비관적 락**을 고려.
3. **유저의 포인트 잔액**: **낙관적 락**을 사용하여 성능을 유지하고, 트래픽이 급격하게 증가하는 경우 **비관적 락**을 고려.